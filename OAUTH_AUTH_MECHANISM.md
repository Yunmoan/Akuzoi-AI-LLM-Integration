# OAuth认证机制说明

## 认证流程

### 1. 初始登录流程
```
用户点击OAuth登录 → 跳转到OAuth服务器 → 用户授权 → 返回授权码 → 
后端用授权码换取访问令牌 → 获取用户信息 → 创建/更新用户记录 → 
生成JWT token → 返回给前端 → 前端保存JWT token
```

### 2. 后续请求验证
```
前端发送请求 → 携带JWT token → 后端验证JWT → 从数据库获取用户信息 → 
返回响应
```

## 关键点

### OAuth只用于初始登录
- OAuth授权码只在初始登录时使用
- 授权码有效期很短（通常几分钟），过期是正常现象
- 登录成功后，系统生成自己的JWT token用于后续验证

### JWT用于后续验证
- JWT token有效期较长（默认7天）
- 每次API请求都使用JWT token进行验证
- 验证时从数据库获取最新的用户信息，不依赖OAuth服务器

### 智能认证检查
- 应用启动时检查JWT token是否有效
- 如果JWT token有效，直接进入应用
- 只有在JWT token过期或无效时，才需要重新OAuth登录

## 错误处理

### OAuth授权码过期
- 这是正常现象，不需要特殊处理
- 如果用户已经有有效的JWT token，直接使用
- 如果没有有效token，重新获取OAuth授权链接

### JWT token过期
- 清除本地token
- 跳转到登录页面
- 用户需要重新OAuth登录

### 网络错误
- OAuth服务器连接失败
- 数据库连接失败
- 返回相应的错误信息

## 用户体验优化

### 应用启动检查
```typescript
// 应用启动时检查认证状态
useEffect(() => {
  checkAuth();
}, [checkAuth]);
```

### 智能重定向
- 已登录用户访问登录页面 → 重定向到聊天页面
- 未登录用户访问需要认证的页面 → 重定向到登录页面

### 错误提示
- 授权码过期：提示重新获取授权链接
- JWT过期：提示重新登录
- 网络错误：提示稍后重试

## 安全考虑

### JWT安全
- 使用强密钥签名
- 设置合理的过期时间
- 在服务端验证签名

### OAuth安全
- 验证state参数防止CSRF攻击
- 验证重定向URI
- 使用HTTPS传输

### 数据库安全
- 用户信息存储在本地数据库
- 定期更新用户信息
- 支持用户状态管理（封禁、实名认证等）

## 总结

OAuth只是用来获取初始的用户身份信息，登录成功后系统使用自己的JWT token进行后续的认证。这样的设计有以下优势：

1. **减少对OAuth服务器的依赖**：后续请求不需要访问OAuth服务器
2. **提高性能**：JWT验证比OAuth验证更快
3. **更好的用户体验**：用户不需要频繁重新授权
4. **更灵活的控制**：可以独立管理用户状态和权限
