# 用户调用次数功能使用指南

## 概述

用户调用次数功能允许系统跟踪和管理用户的聊天使用情况，包括每日限制、已使用次数、剩余次数等统计信息。

## 功能特性

### 1. 用户统计信息
- **每日限制**: 用户每天可以发送的最大消息数量（默认100条）
- **今日已用**: 用户今天已经发送的消息数量
- **剩余次数**: 用户今天还可以发送的消息数量
- **总调用次数**: 用户注册以来发送的所有消息数量

### 2. 实时显示
- **聊天页面**: 在左侧边栏显示用户调用次数统计
- **进度条**: 可视化显示今日使用进度
- **颜色提示**: 根据剩余次数显示不同颜色（蓝色/黄色/红色）
- **警告提示**: 当剩余次数不足时显示警告信息

### 3. 限制检查
- **发送前检查**: 发送消息前检查剩余次数
- **超出限制**: 当剩余次数为0时阻止发送消息
- **实时更新**: 发送消息后立即更新统计信息

## 界面说明

### 聊天页面显示

#### 左侧边栏统计卡片
```
┌─────────────────────┐
│  ● 聊天限制         │
├─────────────────────┤
│ [剩余次数] [今日已用]│
│   85        15      │
├─────────────────────┤
│ 使用进度: 15% ████  │
│ 每日限制: 100       │
│ 总调用: 1,234       │
└─────────────────────┘
```

#### 输入区域显示
```
┌─────────────────────────────────────┐
│ [输入框...] [发送按钮]              │
│ 剩余聊天次数: 85                    │
└─────────────────────────────────────┘
```

### 颜色含义
- **蓝色**: 剩余次数充足（>30次）
- **黄色**: 剩余次数较少（10-30次）
- **红色**: 剩余次数不足（≤10次）

### 警告提示
- **黄色警告**: "⚠️ 剩余次数较少，请注意使用"
- **红色警告**: "⚠️ 剩余次数不足，请谨慎使用"

## 管理员功能

### 用户管理页面
- **调用次数列**: 显示用户的今日使用情况和总调用次数
- **用户详情页面**: 详细的统计信息和进度条显示

### 统计信息
```
今日: 15 / 100
总计: 1,234
```

## 技术实现

### 数据库字段
```sql
users 表新增字段:
- daily_message_limit: 每日消息限制（默认100）
- total_messages_sent: 总发送消息数（默认0）
```

### API接口
- `GET /api/admin/users/:userId` - 获取用户详情（包含统计）
- `GET /api/admin/users` - 获取用户列表（包含统计）

### 前端组件
- **ChatPage**: 聊天页面统计显示
- **AdminPage**: 管理员页面用户列表
- **UserDetailPage**: 用户详情页面

## 使用流程

### 普通用户
1. **登录系统** → 进入聊天页面
2. **查看统计** → 左侧边栏显示调用次数
3. **发送消息** → 系统自动检查剩余次数
4. **实时更新** → 发送后统计信息立即更新

### 管理员
1. **访问管理面板** → 查看所有用户统计
2. **查看用户详情** → 详细的统计信息
3. **监控使用情况** → 跟踪用户活跃度

## 配置说明

### 默认设置
- **每日限制**: 100条消息
- **重置时间**: 每天00:00自动重置
- **统计范围**: 按用户ID统计

### 自定义配置
可以通过修改数据库中的 `daily_message_limit` 字段来调整用户的每日限制。

## 注意事项

1. **统计准确性**: 统计基于数据库中的 `chat_records` 表
2. **时区设置**: 统计基于服务器时区的日期
3. **权限控制**: 只有管理员可以查看其他用户的统计信息
4. **实时性**: 统计信息在消息发送后立即更新

## 故障排除

### 统计不显示
- 检查用户是否已登录
- 确认API接口是否正常
- 检查数据库连接状态

### 统计不准确
- 检查 `chat_records` 表数据
- 确认时区设置正确
- 验证统计计算逻辑

### 限制不生效
- 检查前端限制检查逻辑
- 确认后端API响应正确
- 验证用户权限设置

## 测试命令

运行用户统计功能测试：
```bash
npm run test-user-stats
```

这将测试：
- 消息发送功能
- 用户统计信息获取
- 统计信息更新
- 剩余次数计算
- 每日限制检查

## 更新日志

### v1.0.1
- ✅ 添加用户调用次数统计
- ✅ 实现实时显示和更新
- ✅ 添加限制检查和警告
- ✅ 完善管理员查看功能
- ✅ 优化用户界面体验 